#!/bin/bash -e
. /usr/share/debconf/confmodule

msg="LinOTP: "

echo_prio() {
  t=$(date +"%Y/%m/%d - %T")
  echo >&2 "$t $1 [linotp config] $2"
}
echo_info() {
  echo_prio INFO "$1"
}
echo_warn() {
  echo_prio WARNING "$1"
}
echo_log() {
  echo >&2 "${msg}$1"
}

# Just like other maintainer scripts, config scripts must be idempotent. The
# config script is passed 2 parameters. The first is either "configure" or
# "reconfigure". The latter occurs only if a package is being reconfigured by
# dpkg-reconfig. The second parameter is the last version of the package that
# was configured.
#
# http://www.fifi.org/doc/debconf-doc/tutorial.html

# Like the postinst, the config script is passed two parameters when it is run.
# The first tells what action is being performed, and the second is the version
# of the package that is currently installed. So, like in a postinst, you can
# use dpkg --compare-versions on $2 to make some behavior happen only on
# upgrade from a particular version of a package, and things like that.
#
# man debconf-devel


# I have observed following behaviour:
#
#   During first installation or after installing following 'apt-get purge'
#   this script is invoked twice, both times with following output:
#     INFO [linotp config] Installing new package?: true
#     INFO [linotp config] Re-installing package?: false
#     INFO [linotp config] Reconfiguring package?: false
#     INFO [linotp config] Currently installed version:
#     INFO [linotp config] New version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] Version equal:
#     INFO [linotp config] Version upgrade:
#     INFO [linotp config] Version downgrade:
#
#
#  During installation following 'apt-get remove' this script is invoked twice
#  with following output:
#     INFO [linotp config] Installing new package?: true
#     INFO [linotp config] Re-installing package?: false
#     INFO [linotp config] Reconfiguring package?: false
#     INFO [linotp config] Currently installed version:
#     INFO [linotp config] New version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] Version equal:
#     INFO [linotp config] Version upgrade:
#     INFO [linotp config] Version downgrade:
#
#     INFO [linotp config] Installing new package?: false
#     INFO [linotp config] Re-installing package?: true
#     INFO [linotp config] Reconfiguring package?: false
#     INFO [linotp config] Currently installed version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] New version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] Version equal: true
#     INFO [linotp config] Version upgrade:
#     INFO [linotp config] Version downgrade:
#
#
#  During 'dpkg-reconfigure' this script is invoked once with following output:
#     INFO [linotp config] Installing new package?: false
#     INFO [linotp config] Re-installing package?: false
#     INFO [linotp config] Reconfiguring package?: true
#     INFO [linotp config] Currently installed version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] New version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] Version equal: true
#     INFO [linotp config] Version upgrade:
#     INFO [linotp config] Version downgrade:
#
#
#  During package upgrade (dpkg -i) this script is invoked once with following output:
#     INFO [linotp config] Installing new package?: false
#     INFO [linotp config] Re-installing package?: true
#     INFO [linotp config] Reconfiguring package?: false
#     INFO [linotp config] Currently installed version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] New version: 2.9-1~trusty
#     INFO [linotp config] Version equal:
#     INFO [linotp config] Version upgrade: true
#     INFO [linotp config] Version downgrade:
#
#
#  During package downgrade (dpkg -i) this script is invoked once with following output:
#     INFO [linotp config] Installing new package?: false
#     INFO [linotp config] Re-installing package?: true
#     INFO [linotp config] Reconfiguring package?: false
#     INFO [linotp config] Currently installed version: 2.8~0dev0+g09d8dab-1~trusty
#     INFO [linotp config] New version: 2.7.1-1~trusty
#     INFO [linotp config] Version equal:
#     INFO [linotp config] Version upgrade:
#     INFO [linotp config] Version downgrade: true


NEW_VERSION='@@@DEB_VERSION@@@'

INSTALL_ACTION=install
if [ -n "$2" ]; then
  INSTALLED_VERSION="$2"
  if dpkg --compare-versions "${NEW_VERSION}" eq "${INSTALLED_VERSION}"; then
    INSTALL_ACTION=reinstall
  elif dpkg --compare-versions "${NEW_VERSION}" gt "${INSTALLED_VERSION}"; then
    INSTALL_ACTION=upgrade
  else
    INSTALL_ACTION=downgrade
  fi
fi


if [ "$1" = "reconfigure" ]; then
  INSTALL_MODE=reconfigure
elif [ "$1" = "configure" ]; then
  if [ -n "${INSTALLED_VERSION}" ]; then
    INSTALL_MODE=reinstall
  else
    INSTALL_MODE=install
  fi
fi

print_timestamp() {
  date +"%Y/%m/%d - %T"
}

# Always print to stderr, otherwise debconf can get confused
echo_info "Installation mode: $INSTALL_MODE"
echo_info "Installed version: ${INSTALLED_VERSION:-(none)}"
echo_info "New version: $NEW_VERSION"
echo_info "Installation action: $INSTALL_ACTION"

db_input high linotp/apache/activate || true
db_go
db_get linotp/apache/activate
APACHE=$RET

dbc_dbtypes="mysql, pgsql"
if [ "$APACHE" = "true" ]; then
  db_input high linotp/apache/admin_password || true
  db_go

  db_input high linotp/apache/ssl_create || true
  db_go
else
  # If not using apache, you can also choose SQLlite
  dbc_dbtypes="$dbc_dbtypes, sqlite"
fi

# Database configuration using dbconfig-common
if [ -f /usr/share/dbconfig-common/dpkg/config ]; then
  # Load library
  . /usr/share/dbconfig-common/dpkg/config

  # Define default values for database
  #dbc_authmethod_user="password"
  dbc_first_version="3.0~a1"


  # Ask questions
  dbc_go linotp "$@"
fi
